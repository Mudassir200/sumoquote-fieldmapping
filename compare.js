// data = {
//     "ReportId": "1",
//     "Id": "073b54e7-e881-4b1c-9235-2c7183018c0b",
//     "ProjectId": "e68fc7c2-7cfa-4029-a9f6-97076f3d1b14",
//     "TitleReportPage": {
//         "ReportType": "Sink",
//         "ReportDate": "2022-03-02T00:00:00",
//         "ClientLogoId": null,
//         "PrimaryImageId": null,
//         "BuildingHomeOwnerName": null,
//         "CustomerFirstName": "Mart",
//         "CustomerLastName": "",
//         "AddressLine1": "sdsdfsdfsds",
//         "AddressLine2": null,
//         "City": null,
//         "Province": null,
//         "PostalCode": null,
//         "CustomerFullName": "Mart",
//         "IsVisible": false,
//         "PageIndex": 0,
//         "PageTitle": "Title",
//         "Change": false,
//         "CanOrder": true,
//         "ExcludedFromReport": false
//     },
//     "ExecutiveSummaryPage": {
//         "PageIndex": 1,
//         "Summary": null,
//         "IsVisible": false,
//         "PageTitle": "Introduction",
//         "Change": false,
//         "CanOrder": true,
//         "ExcludedFromReport": false
//     },
//     "InspectionPage": {
//         "InspectionSections": [
//             {
//                 "SectionId": 1,
//                 "SectionTitle": "",
//                 "InspectionItems": [
//                     {
//                         "ItemId": 1,
//                         "ImageId": "",
//                         "Summary": ""
//                     }
//                 ]
//             }
//         ],
//         "IsVisible": false,
//         "PageIndex": 2,
//         "PageTitle": "Inspection",
//         "Change": false,
//         "CanOrder": true,
//         "ExcludedFromReport": false
//     },
//     "AuthorizationPage": {
//         "AuthorizationSections": [
//             {
//                 "SectionId": 1,
//                 "SectionTitle": "",
//                 "InvoiceEnabled": false,
//                 "AuthorizationItems": [
//                     {
//                         "ItemId": 1,
//                         "ItemUUID": "feb07f9f-ef1b-435f-a110-9a1131559a88",
//                         "Quantity": 0.0,
//                         "Price": 0.0,
//                         "Description": "",
//                         "Selected": false,
//                         "InvoiceEnabled": false,
//                         "PriceDetailId": null,
//                         "PriceDetailName": null,
//                         "TierPayments": [],
//                         "IsTaxExempted": false
//                     }
//                 ]
//             }
//         ],
//         "ProductSelections": [],
//         "Signatories": [
//             {
//                 "SignatoryId": "86ac437d-2384-492a-b75d-f42c10118e88",
//                 "Name": null,
//                 "FirstName": "Mart",
//                 "LastName": "",
//                 "EmailAddress": "tyav2greenz@gmail.com",
//                 "SigningOrder": 1,
//                 "NameLabel": "Primary signer",
//                 "IsPrimary": true,
//                 "FullName": "Mart",
//                 "AddToCreditApplication": true
//             }
//         ],
//         "Signatures": [
//             {
//                 "SignatoryId": "86ac437d-2384-492a-b75d-f42c10118e88",
//                 "FirstName": "Mart",
//                 "LastName": "",
//                 "FullName": "Mart",
//                 "EmailAddress": "tyav2greenz@gmail.com",
//                 "SigningOrder": 1,
//                 "Signature": "Ty Mo",
//                 "SignatureRequestedOn": "2022-03-02T17:48:37.6272833+00:00",
//                 "SignedOn": "2022-03-02T17:48:49.6524819+00:00",
//                 "PrimarySignatory": true,
//                 "CustomerSignatureConfirmation": true,
//                 "SignatoryInitial": {
//                     "TermsAcknowledgementRequired": false,
//                     "TermsAcknowledged": false,
//                     "TermsPageName": null,
//                     "TermsAcknowledgedDate": null,
//                     "SignatoryCustomPageInitials": []
//                 },
//                 "SigningIP": "197.210.28.203",
//                 "InkSignature": ""
//             }
//         ],
//         "Disclaimer": null,
//         "Notes": null,
//         "CustomerNotes": "",
//         "SelectionsTitle": "My Product Selections",
//         "InPersonSignature": false,
//         "ManuallySigned": false,
//         "PriceDisplayOption": {
//             "DisplayItemQuantity": true,
//             "DisplayItemUnitPrice": true
//         },
//         "FinancingTier": "8d47a3b8-87ce-4887-8fc6-5560ebd834b7",
//         "IsVisible": true,
//         "PageIndex": 4,
//         "PageTitle": "Authorization Page",
//         "Change": false,
//         "CanOrder": true,
//         "ExcludedFromReport": false
//     },
//     "EstimateDetailsPage": {
//         "EstimateSections": [
//             {
//                 "SectionId": 1,
//                 "SectionTitle": "",
//                 "InvoiceEnabled": false,
//                 "Show": true,
//                 "EstimateItems": [
//                     {
//                         "ItemId": 1,
//                         "ItemUUID": null,
//                         "Quantity": 0.0,
//                         "Price": 0.0,
//                         "Description": "",
//                         "InvoiceEnabled": false,
//                         "PriceDetailId": null,
//                         "PriceDetailName": null,
//                         "IsTaxExempted": false
//                     }
//                 ]
//             }
//         ],
//         "Notes": null,
//         "ShowCustomerPricing": false,
//         "TieredPricing": true,
//         "Tier1": {
//             "TierId": "8d47a3b8-87ce-4887-8fc6-5560ebd834b7",
//             "Show": true,
//             "Selected": true,
//             "Name": "Quote Details",
//             "EstimateSections": [
//                 {
//                     "SectionId": 1,
//                     "SectionTitle": "",
//                     "InvoiceEnabled": false,
//                     "Show": true,
//                     "EstimateItems": [
//                         {
//                             "ItemId": 1,
//                             "ItemUUID": "a95c059d-293a-43c4-8a86-308973fa1b26",
//                             "Quantity": 1.0,
//                             "Price": 100.0,
//                             "Description": "sink",
//                             "InvoiceEnabled": false,
//                             "PriceDetailId": null,
//                             "PriceDetailName": null,
//                             "IsTaxExempted": false
//                         },
//                         {
//                             "ItemId": 2,
//                             "ItemUUID": "ce24da21-c321-4f49-aaae-d0720a1382f6",
//                             "Quantity": 5.0,
//                             "Price": 30.0,
//                             "Description": "pipe",
//                             "InvoiceEnabled": false,
//                             "PriceDetailId": null,
//                             "PriceDetailName": null,
//                             "IsTaxExempted": false
//                         }
//                     ]
//                 }
//             ],
//             "Notes": null,
//             "LinkedTier": null,
//             "LinkedTierDescription": null,
//             "Financing": null,
//             "FinancingCost": 0.0
//         },
//         "Tier2": {
//             "TierId": "3f4e8c3d-1ff4-4a71-a5aa-ddb2862aa3f7",
//             "Show": false,
//             "Selected": false,
//             "Name": "New Quote",
//             "EstimateSections": [
//                 {
//                     "SectionId": 1,
//                     "SectionTitle": "",
//                     "InvoiceEnabled": false,
//                     "Show": true,
//                     "EstimateItems": [
//                         {
//                             "ItemId": 1,
//                             "ItemUUID": "2d60c307-0cb6-4c17-a55b-74157c3390c9",
//                             "Quantity": 0.0,
//                             "Price": 0.0,
//                             "Description": "",
//                             "InvoiceEnabled": false,
//                             "PriceDetailId": null,
//                             "PriceDetailName": null,
//                             "IsTaxExempted": false
//                         }
//                     ]
//                 }
//             ],
//             "Notes": null,
//             "LinkedTier": null,
//             "LinkedTierDescription": null,
//             "Financing": null,
//             "FinancingCost": 0.0
//         },
//         "Tier3": {
//             "TierId": "b26a531b-e15d-494c-b102-43b3d05af9f8",
//             "Show": false,
//             "Selected": false,
//             "Name": "New Quote",
//             "EstimateSections": [
//                 {
//                     "SectionId": 1,
//                     "SectionTitle": "",
//                     "InvoiceEnabled": false,
//                     "Show": true,
//                     "EstimateItems": [
//                         {
//                             "ItemId": 1,
//                             "ItemUUID": "1f1b0acb-885f-4bea-94e2-84b5e7722443",
//                             "Quantity": 0.0,
//                             "Price": 0.0,
//                             "Description": "",
//                             "InvoiceEnabled": false,
//                             "PriceDetailId": null,
//                             "PriceDetailName": null,
//                             "IsTaxExempted": false
//                         }
//                     ]
//                 }
//             ],
//             "Notes": null,
//             "LinkedTier": null,
//             "LinkedTierDescription": null,
//             "Financing": null,
//             "FinancingCost": 0.0
//         },
//         "TiersAreMutuallyExclusive": true,
//         "PriceDisplayOption": {
//             "DisplayItemQuantity": true,
//             "DisplayItemUnitPrice": true,
//             "DisplayItemToalPrice": true,
//             "DisplaySectionTotalPrice": true
//         },
//         "FinancingOptions": {
//             "FinancingEnabled": false,
//             "ShowQuoteTotal": false
//         },
//         "TaxRates": [],
//         "IsVisible": true,
//         "PageIndex": 3,
//         "PageTitle": "Quote Details",
//         "Change": false,
//         "CanOrder": true,
//         "ExcludedFromReport": false
//     },
//     "TermsAndConditionsPage": {
//         "Summary": "",
//         "Pdf": {
//             "Name": null,
//             "Id": null,
//             "ParentId": null,
//             "Folder": null
//         },
//         "SummarySelected": true,
//         "SignatoryAcknowledgementRequired": false,
//         "UpdatedDate": null,
//         "IsVisible": false,
//         "PageIndex": 5,
//         "PageTitle": "Terms and Conditions",
//         "Change": false,
//         "CanOrder": true,
//         "ExcludedFromReport": false
//     },
//     "WarrantyPage": {
//         "Details": null,
//         "Thanks": null,
//         "Signature": null,
//         "SigneeName": null,
//         "SigneeTitle": null,
//         "StartDate": null,
//         "UpdatedDate": null,
//         "IsVisible": false,
//         "PageIndex": 6,
//         "PageTitle": "Warranty",
//         "Change": false,
//         "CanOrder": true,
//         "ExcludedFromReport": false
//     },
//     "CustomPages": [],
//     "InvoiceTermsPage": {
//         "Terms": null,
//         "Notes": null,
//         "IsVisible": false,
//         "PageIndex": 1000,
//         "PageTitle": "Invoice Defaults",
//         "Change": false,
//         "CanOrder": false,
//         "ExcludedFromReport": false
//     },
//     "SumoTax": null,
//     "SentForSignatureOn": "2022-03-02T17:48:37.6372672+00:00",
//     "Signature": null,
//     "SignatureDate": "2022-03-02T17:48:50.2234722+00:00",
//     "SignedPDFId": "Moses API Account Quote 4193800641 - 1.pdf",
//     "PublicQuoteReview": "8b24f2bb-c117-4de2-b524-6caf7b9f9416",
//     "DisplayOnPRO": false,
//     "ReportLayoutName": "Default Account Layout",
//     "ReportLayoutId": "7d22b5d9-9556-48ac-b99a-81189937dbae",
//     "IncludeInAutoGeneratedRevenue": true,
//     "TotalSignedValue": 250.0,
//     "MetaData": null,
//     "TaxRates": null
// }
// function sumObject(obj) {
//     return obj.Quantity * obj.Price;
// }

// // function getObjectDetail(obj) {
// //     return {
// //         name: obj.Description
// //         ,
// //         'price': obj.Price
// //         ,
// //         "quantity": obj.Quantity
// //     }
// // }

function sumEstimateItems(total, current) {
    return total + sumObject(current)
}

// function getExtimateItemsDetails(details, item) {
//     if (item.Quantity * item.Price) {
//         return [...details, getObjectDetail(item)]
//     }
//     return details
// }

function sumEstimateSections(total, current) {
    let estimatedItems = current.EstimateItems.reduce(sumEstimateItems, 0)
    return total + estimatedItems
}

// function getEstimateSectionsDetails(details, section) {
//     let sectionDetails = section.EstimateItems.reduce(getExtimateItemsDetails, [])
//     return [...details, ...sectionDetails]
// }

function getTierSum(tier) {
    if (!tier) return 0
    return tier.EstimateSections.reduce(sumEstimateSections, 0)
}

// function getTierDetails(tier) {
//     if (!tier || !tier.Selected) {
//         return []
//     }
//     return tier.EstimateSections.reduce(getEstimateSectionsDetails, [])
// }

function getAuthItemSum(acc, sect) {
    return acc + sect.AuthorizationItems.reduce((acc, item) => {
        if (item.Selected) {
            return acc + (item.Price * item.Quantity)
        }
        return acc
    }, 0)

}

// function getAuthItemDetails(acc, sect) {
//     return [...acc, ...sect.AuthorizationItems.reduce((acc, item) => {
//         if (item.Selected) {
//             return [...acc, getObjectDetail(item)]
//         }
//         return acc
//     }, [])]
// }

function getAuthSectSum(authSect) {
    if (!authSect) return 0;
    return authSect.reduce(getAuthItemSum, 0)
}

// function getAuthSectDetails(authSect) {
//     if (!authSect) return 0;
//     return authSect.reduce(getAuthItemDetails, [])
// }

exports.sumTiers = async (a) => {
    return getTierSum(a.Tier1) + getTierSum(a.Tier2) + getTierSum(a.Tier3) + getTierSum(a) + getAuthSectSum(a.AuthorizationPage?.AuthorizationSections)
}

// function getTierItemDetails(a) {
//     try {
//         return [
//             ...getTierDetails(a.EstimateDetailsPage.Tier1),
//             ...getTierDetails(a.EstimateDetailsPage.Tier2),
//             ...getTierDetails(a.EstimateDetailsPage.Tier3),
//             ...getAuthSectDetails(a.AuthorizationPage.AuthorizationSections)]
        
//     } catch (error) {
//         console.log(error)
//         throw error
//     }
// }


exports.getTierItemDetails = async(a) => {
    try {
        const data = [
            ...await this.getTierDetails(a.EstimateDetailsPage.Tier1),
            ...await this.getTierDetails(a.EstimateDetailsPage.Tier2),
            ...await this.getTierDetails(a.EstimateDetailsPage.Tier3),
            ...await this.getAuthSectDetails(a.AuthorizationPage.AuthorizationSections)
        ]
        return data
    } catch (error) {
        return {from: '(controller/sumoquote/getTierItemDetails) Function Error :- ', message: error};
    }
}

exports.getObjectDetail = async (obj) => {
    return {
        name: obj.PriceDetailName,  //Description
        'description': obj.Description,  //Description
        'price': obj.Price,
        'total': parseFloat(obj.Price * obj.Quantity).toFixed(2),
        "quantity": obj.Quantity
    }
}

exports.getAuthSectDetails = async (authSect) =>{
    try {
        if (!authSect) return [];
        let AuthDetails = [];
        await authSect.map(async (authSection) => { 
            await authSection.AuthorizationItems.map(async (item) => { 
                if (!item || !item.Selected) {
                    return []
                }
                let lineItem = await this.getObjectDetail(item)
                AuthDetails.push(lineItem);
            })
        })
        return AuthDetails;
    } catch (error) {
        return {from: '(controller/sumoquote/getAuthSectDetails) Function Error :- ', message: error.message};
    }
}

exports.getTierDetails = async (tier) => {
    try {
        if (!tier || !tier.Selected) {
            return []
        }
        const tireDetails = [];
        await tier.EstimateSections.map(async (EstimateSections) => {
            await EstimateSections.EstimateItems.map(async (item) => {
                if (item.Quantity * item.Price) {
                    let lineItem = await this.getObjectDetail(item)
                    tireDetails.push(lineItem);
                }
            })
        })
        return tireDetails;
    } catch (error) {
        return {from: '(controller/sumoquote/getTierDetails) Function Error :- ', message: error.message};
    }
}
